
UZCampusWebMapApp.service('geoService', function(sharedProperties, infoService, poisService, APP_CONSTANTS, $ionicModal, $ionicPopup) {

    return ({
        crearMapa: crearMapa,
        localizarHuesca: localizarHuesca,
        localizarZaragoza: localizarZaragoza,
        localizarTeruel: localizarTeruel,
        crearPlano: crearPlano,
        updatePOIs: updatePOIs
    });

    function crearMapa($scope, infoService){
        var option = sharedProperties.getOpcion();
        option = typeof option !== 'undefined' ? option : 1;
        sharedProperties.setOpcion(option);

        //Initial layers
        var ggl = new L.Google('ROADMAP');
        var satelite = new L.Google('SATELLITE');
        var hybrid = new L.Google('HYBRID');
        var openstreetmap = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            maxZoom:50,
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        });

        var baseMaps = {
            "Google Roadmap": ggl,
            "Google Satelite": satelite,
            "Google Hibrida": hybrid,
            "Open Street Map": openstreetmap
        };

        $scope.map = L.map('mapa'
            ,{
                crs: L.CRS.EPSG3857,
                layers: [openstreetmap]
            }
        ).setView([APP_CONSTANTS.datosMapa[option].latitud, APP_CONSTANTS.datosMapa[option].longitud], 16);
        $scope.map.attributionControl.setPrefix('');
        L.control.layers(baseMaps, {}, {position: 'bottomleft'}).addTo($scope.map);

        var buildingsLayer = new L.TileLayer.WMS(APP_CONSTANTS.URI_Geoserver_2 + "sigeuz/wms", {
            layers: 'sigeuz:bordes',
            format: 'image/png',
            styles: 'show_hide_label_with_zoom',
            transparent: true,
            minZoom: 15,
            maxZoom: 25,
            zIndex: 1000,
            attribution: "Edificios"
        });

        $scope.map.addLayer(buildingsLayer,"Edificios");

        L.control.locate().addTo($scope.map);

        sharedProperties.setMarkerLayer(new L.LayerGroup());
        $scope.map.addLayer(sharedProperties.getMarkerLayer());
        var controlSearch = new L.Control.Search({layer: sharedProperties.getMarkerLayer(), initial: false, position:'topright'});
        $scope.map.addControl(controlSearch);

        var src = new Proj4js.Proj('EPSG:4326');
        var dst = new Proj4js.Proj('EPSG:25830');

        $scope.map.on('click', function(e)
        {
            var owsrootUrl = APP_CONSTANTS.URI_Geoserver_2 + 'ows';
            var selectedPoint = e.latlng;
            var p = new Proj4js.Point(e.latlng.lng,e.latlng.lat);
            Proj4js.transform(src, dst, p);
            
            var defaultParameters = {
                service : 'WFS',
                version : '1.1.1',
                request : 'GetFeature',
                typeName : 'sigeuz:bordes',
                maxFeatures : 500,
                outputFormat : 'text/javascript',
                format_options : 'callback:getJson',
                SrsName : 'EPSG:4326'
            };
            
            var customParams = {
                cql_filter:'DWithin(geom, POINT(' + p.x + ' ' + p.y + '), 0.1, meters)'
            };

            var parameters = L.Util.extend(defaultParameters, customParams);

            $.ajax({
                url : owsrootUrl + L.Util.getParamString(parameters),
                dataType : 'jsonp',
                jsonpCallback : 'getJson',
                success: function(data){
                    console.log("Success getting building info", data);
                    if (data.features.length > 0) {
                        var lastMapMarker = sharedProperties.getLastMapMarker();
                        if (lastMapMarker) {
                            sharedProperties.getMarkerLayer().removeLayer(lastMapMarker);
                        }
                        $scope.map.panTo(selectedPoint);
                        showMarker($scope, data, selectedPoint, infoService);
                    }
                }
            });
        });

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                sharedProperties.setLatUser(position.coords.latitude);
                sharedProperties.setLonUser(position.coords.longitude);
            });
        }

        sharedProperties.setMapa($scope.map);
        return $scope.map;
    }

    // Show marker with building info over selected building
    function showMarker($scope, data, point, infoService){

        var coordenadas = data.features[0].geometry.coordinates[0][0][0];
        var edificioName = data.features[0].properties.cod3;

        infoService.getInfoEdificio(edificioName).then(
            function (dataEdificio) {
                console.log("Data building", dataEdificio);
                if (dataEdificio.length > 0  && typeof(dataEdificio) != 'undefined' && dataEdificio != null)
                {
                    var edificio = dataEdificio[0];

                    var html_header = '<div id="popup" class="text-center map-mark"><b>'+edificio.edificio+'</b><br>'+edificio.direccion+'</div> ';

                    var html_select = '<div>' + $scope.translation.SELECCIONAR_PLANTA;
                    html_select += '<select class="ion-input-select select-map" onchange="selectPlano(this);" ng-model="plantaPopup" >';
                    html_select+='<option value=undefined selected="selected"></option>';

                    // Load building floor values in HTML 'select' element
                    for (i=0;i<edificio.plantas.length;i++)
                    {
                        var floorValue = edificio.plantas[i],
                            selectClass = 'class="'+floorValue+'"',
                            selectValueAttr = 'value="'+floorValue+'"',
                            dataEdificioFloor = 'data-building="'+edificio.ID_Edificio+'"',
                            attributes = [selectClass, selectValueAttr, dataEdificioFloor].join(' ');

                        html_select+='<option '+attributes+'>'+floorValue+'</option>';
                    }
                    html_select+='</select>';

                    var redireccion = "'https://maps.google.es/maps?saddr=" +
                        sharedProperties.getLatUser() + "," + sharedProperties.getLonUser() +
                        "&daddr=" + point.lng + ',' + point.lat +"&output=embed'";

                    var html_button='<button class="button button-small button-positive button-how" onclick="location.href ='+redireccion+'" >'+$scope.translation.HOWTOARRIVE+' </button></div>';
                    var html = html_header + html_select + html_button;
                    var myIcon = L.icon({
                        iconUrl: '',
                        iconSize: [5, 5]
                    });
                    var marker = new L.marker(point,{opacity: 0, title:edificio.edificio}).addTo($scope.map).bindPopup(html);

                    var markerLayer = sharedProperties.getMarkerLayer();
                    markerLayer.addLayer(marker);
                    sharedProperties.setMarkerLayer(markerLayer);
                    sharedProperties.setLastMapMarker(marker);
                    marker.fireEvent('click');
                }
                else {
                    console.log("Error on getInfoEdificio, data invalid", err);
                    var errorMsg = '<div class="text-center">Ha ocurrido un error recuperando<br>';
                    errorMsg += 'información del edificio</div>';
                    showInfoPopup('¡Error!', errorMsg);
                }
            },
            function(err){
                console.log("Error on getInfoEdificio", err);
                var errorMsg = '<div class="text-center">Ha ocurrido un error recuperando<br>';
                errorMsg += 'información de algunos edificios</div>';
                showInfoPopup('¡Error!', errorMsg);
            }
        );
    }

    function localizarHuesca() {
        var cityData = APP_CONSTANTS.datosMapa;
        console.log('Cambio vista a: '+ cityData[0].nombre+' '+cityData[0].latitud+' '+cityData[0].longitud);
        var mapa = sharedProperties.getMapa();
        if (mapa) {
            mapa.setView(new L.LatLng(cityData[0].latitud, cityData[0].longitud), 14);
            mapa.zoomIn(); mapa.zoomOut();
        }
        sharedProperties.setMapa(mapa);
    }

    function localizarZaragoza() {
        cityData = APP_CONSTANTS.datosMapa;
        console.log('Cambio vista a: '+ cityData[1].nombre+' '+cityData[1].latitud+' '+cityData[1].longitud);
        var mapa = sharedProperties.getMapa();
        if (mapa) {
            mapa.setView(new L.LatLng(cityData[1].latitud, cityData[1].longitud), 16);
            mapa.zoomIn(); mapa.zoomOut();
        }
        sharedProperties.setMapa(mapa);
    }

    function localizarTeruel() {
        cityData = APP_CONSTANTS.datosMapa;
        console.log('Cambio vista a: '+ cityData[2].nombre+' '+cityData[2].latitud+' '+cityData[2].longitud);
        var mapa = sharedProperties.getMapa();
        if (mapa) {
            mapa.setView(new L.LatLng(cityData[2].latitud, cityData[2].longitud), 16);
            mapa.zoomIn(); mapa.zoomOut();
        }
        sharedProperties.setMapa(mapa);
    }

    function crearPlano($scope, $http, infoService, sharedProperties, poisService, createModal) {
        
        //Close opened popup on previous map
        var mapa = sharedProperties.getMapa();
        if (typeof(mapa) != 'undefined') mapa.closePopup();
        
        var building = localStorage.building.indexOf('building') == -1 ? localStorage.building : JSON.parse(localStorage.building).building,
            floor = localStorage.planta,
            planta_id = building + floor;

        edificio_id = planta_id.replace(/\./g,"_").toLowerCase();

        var url = APP_CONSTANTS.URI_Geoserver_1 + 'proyecto/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=proyecto:'+edificio_id+'&srsName=epsg:4326&outputFormat=application/json';
        /*$.ajax({
            url : url,
            type: 'GET',
            dataType : 'json',
            crossDomain: true,
            headers: { 'Access-Control-Allow-Origin': '*' },
            success: function(data) {
                handleJson(data, sharedProperties, poisService, createModal, function(plano){
                    addLegend(plano, function(){
                        // Define legend behaviour
                        $('.legend').hide();
                        $('.legend-button').click(function(){
                            if ($('.legend').is(":visible")) $('.legend').hide(500);
                            else $('.legend').show(500);
                        });
                        sharedProperties.setPlano(plano);
                    });
                });
            }
        });*/

        var data = {"type":"FeatureCollection","totalFeatures":26,"features":[{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f2e","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.898605375464307,41.642434055015826],[-0.8986037350918218,41.64243315061276],[-0.898604949414137,41.64243184232853],[-0.8986046916413252,41.64243170020805],[-0.8986411559826252,41.64239241429469],[-0.8986135274379952,41.64237718156867],[-0.8986206051941178,41.64236955613948],[-0.8986297912731739,41.64237462079493],[-0.8986436692205096,41.64235966897044],[-0.898634483142396,41.642354604316125],[-0.8986348647858822,41.64235419314096],[-0.8986350522568503,41.64235429650126],[-0.8986362665769976,41.642352988216615],[-0.8986379069479686,41.64235389261919],[-0.8986388784040404,41.64235284599147],[-0.8986372380330807,41.64235194158889],[-0.8986384523531393,41.64235063330423],[-0.8986382648821768,41.64235052994393],[-0.898638646525614,41.64235011876875],[-0.8986478326034434,41.642355183422744],[-0.8986617105423359,41.64234023159585],[-0.8986525244654496,41.64233516694298],[-0.8986731338881677,41.642312962730536],[-0.8986865966446989,41.6423203852867],[-0.8987004738729679,41.64230543420243],[-0.8987137022925129,41.642312727555215],[-0.8986983380046717,41.642329280774504],[-0.8986992753596879,41.64232979757546],[-0.8987236949872819,41.6423034882835],[-0.8987239527598674,41.642303630403745],[-0.8987251670772602,41.642302322118084],[-0.8987268074482708,41.6423032265194],[-0.8987269462273954,41.642303077001046],[-0.8987276401230156,41.642302329409226],[-0.898743115454439,41.64231086156818],[-0.8987424215588998,41.64231160916008],[-0.8987429749979776,41.64231191429274],[-0.8986246659045576,41.642439378287705],[-0.8986212654696325,41.6424430418429],[-0.8986052366846126,41.64243420453404],[-0.898605375464307,41.642434055015826]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.010"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f2d","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.898605375464307,41.642434055015826],[-0.8986037350918218,41.64243315061276],[-0.898604949414137,41.64243184232853],[-0.8986046916413252,41.64243170020805],[-0.8986411559826252,41.64239241429469],[-0.8986135274379952,41.64237718156867],[-0.8986206051941178,41.64236955613948],[-0.8986297912731739,41.64237462079493],[-0.8986436692205096,41.64235966897044],[-0.898634483142396,41.642354604316125],[-0.8986348647858822,41.64235419314096],[-0.8986350522568503,41.64235429650126],[-0.8986362665769976,41.642352988216615],[-0.8986379069479686,41.64235389261919],[-0.8986388784040404,41.64235284599147],[-0.8986372380330807,41.64235194158889],[-0.8986384523531393,41.64235063330423],[-0.8986382648821768,41.64235052994393],[-0.898638646525614,41.64235011876875],[-0.8986478326034434,41.642355183422744],[-0.8986617105423359,41.64234023159585],[-0.8986525244654496,41.64233516694298],[-0.8986731338881677,41.642312962730536],[-0.8986865966446989,41.6423203852867],[-0.8987004738729679,41.64230543420243],[-0.8987137022925129,41.642312727555215],[-0.8986983380046717,41.642329280774504],[-0.8986992753596879,41.64232979757546],[-0.8987236949872819,41.6423034882835],[-0.8987239527598674,41.642303630403745],[-0.8987251670772602,41.642302322118084],[-0.8987268074482708,41.6423032265194],[-0.8987269462273954,41.642303077001046],[-0.8987276401230156,41.642302329409226],[-0.898743115454439,41.64231086156818],[-0.8987424215588998,41.64231160916008],[-0.8987429749979776,41.64231191429274],[-0.8986246659045576,41.642439378287705],[-0.8986212654696325,41.6424430418429],[-0.8986052366846126,41.64243420453404],[-0.898605375464307,41.642434055015826]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.010"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f2c","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.8986037542856535,41.6424311834063],[-0.898603496512846,41.642431041285796],[-0.8986022821905162,41.64243234957003],[-0.8986006418181195,41.64243144516689],[-0.8986005030384204,41.64243159468511],[-0.8985775378296998,41.6424189330391],[-0.8985776766094247,41.64241878352094],[-0.898576036237721,41.64241787911748],[-0.8985772505602863,41.64241657083354],[-0.8985770630892397,41.64241646747314],[-0.898612833540246,41.64237792915973],[-0.8986395247295926,41.64239264508448],[-0.8986037542856535,41.6424311834063]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.020"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f2b","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.8986037542856535,41.6424311834063],[-0.898603496512846,41.642431041285796],[-0.8986022821905162,41.64243234957003],[-0.8986006418181195,41.64243144516689],[-0.8986005030384204,41.64243159468511],[-0.8985775378296998,41.6424189330391],[-0.8985776766094247,41.64241878352094],[-0.898576036237721,41.64241787911748],[-0.8985772505602863,41.64241657083354],[-0.8985770630892397,41.64241646747314],[-0.898612833540246,41.64237792915973],[-0.8986395247295926,41.64239264508448],[-0.8986037542856535,41.6424311834063]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.020"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f2a","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.8986433208001723,41.6424789352775],[-0.8985886729319686,41.642448805740024],[-0.8986011978015503,41.64243531172539],[-0.8986015493115281,41.64243550552437],[-0.8986027636339343,41.64243419724014],[-0.8986044040064295,41.642435101643244],[-0.8986045427861286,41.64243495212504],[-0.8986275080059233,41.64244761376586],[-0.8986273692262489,41.64244776328411],[-0.8986290095994411,41.64244866768685],[-0.8986277952772702,41.642449975971346],[-0.8986292481792936,41.64245077701378],[-0.8986304625014493,41.64244946872926],[-0.8986321028747292,41.642450373131965],[-0.8986322416543988,41.64245022361371],[-0.8986552068851508,41.64246288524925],[-0.8986550681055047,41.642463034767495],[-0.8986567084794792,41.642463939169865],[-0.8986554941575594,41.64246524745465],[-0.8986558456662763,41.64246544125517],[-0.8986433208001723,41.6424789352775]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.030"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f29","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.8986433208001723,41.6424789352775],[-0.8985886729319686,41.642448805740024],[-0.8986011978015503,41.64243531172539],[-0.8986015493115281,41.64243550552437],[-0.8986027636339343,41.64243419724014],[-0.8986044040064295,41.642435101643244],[-0.8986045427861286,41.64243495212504],[-0.8986275080059233,41.64244761376586],[-0.8986273692262489,41.64244776328411],[-0.8986290095994411,41.64244866768685],[-0.8986277952772702,41.642449975971346],[-0.8986292481792936,41.64245077701378],[-0.8986304625014493,41.64244946872926],[-0.8986321028747292,41.642450373131965],[-0.8986322416543988,41.64245022361371],[-0.8986552068851508,41.64246288524925],[-0.8986550681055047,41.642463034767495],[-0.8986567084794792,41.642463939169865],[-0.8986554941575594,41.64246524745465],[-0.8986558456662763,41.64246544125517],[-0.8986433208001723,41.6424789352775]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.030"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f28","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.898543747507526,41.64249777983652],[-0.8985422946055766,41.64249697879302],[-0.8985410802807414,41.642498287076535],[-0.8985394399076018,41.64249738267252],[-0.8985393011276146,41.642497532190625],[-0.8985163359084927,41.642484870532265],[-0.8985164746885014,41.642484721014185],[-0.8985148343160578,41.64248381660983],[-0.8985160486411279,41.64248250832662],[-0.8985158611699964,41.64248240496613],[-0.8985736629859293,41.64242013066815],[-0.8985738504569801,41.64242023402855],[-0.898575064779634,41.64241892574462],[-0.8985767051513487,41.64241983014809],[-0.8985768439310758,41.64241968062992],[-0.8985998091399122,41.64243234227607],[-0.8985996703602098,41.64243249179427],[-0.8986013107326175,41.64243339619741],[-0.8986000964086119,41.64243470448329],[-0.8986004479185823,41.64243489828226],[-0.8985873679282737,41.642448990371214],[-0.8986013345310822,41.64245669071865],[-0.8985552596168652,41.6425063307486],[-0.8985440347759507,41.64250014204212],[-0.898544173555933,41.64249999252401],[-0.8985425331827046,41.64249908812004],[-0.898543747507526,41.64249777983652]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.040"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f27","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.898543747507526,41.64249777983652],[-0.8985422946055766,41.64249697879302],[-0.8985410802807414,41.642498287076535],[-0.8985394399076018,41.64249738267252],[-0.8985393011276146,41.642497532190625],[-0.8985163359084927,41.642484870532265],[-0.8985164746885014,41.642484721014185],[-0.8985148343160578,41.64248381660983],[-0.8985160486411279,41.64248250832662],[-0.8985158611699964,41.64248240496613],[-0.8985736629859293,41.64242013066815],[-0.8985738504569801,41.64242023402855],[-0.898575064779634,41.64241892574462],[-0.8985767051513487,41.64241983014809],[-0.8985768439310758,41.64241968062992],[-0.8985998091399122,41.64243234227607],[-0.8985996703602098,41.64243249179427],[-0.8986013107326175,41.64243339619741],[-0.8986000964086119,41.64243470448329],[-0.8986004479185823,41.64243489828226],[-0.8985873679282737,41.642448990371214],[-0.8986013345310822,41.64245669071865],[-0.8985552596168652,41.6425063307486],[-0.8985440347759507,41.64250014204212],[-0.898544173555933,41.64249999252401],[-0.8985425331827046,41.64249908812004],[-0.898543747507526,41.64249777983652]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.040"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f26","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.8985980438855037,41.64252771559495],[-0.8985976923766344,41.64252752179428],[-0.8985964780522985,41.64252883007834],[-0.8985948376775921,41.64252792567513],[-0.8985946988976645,41.642528075193304],[-0.8985717336566255,41.642515413545574],[-0.8985718724365792,41.64251526402741],[-0.8985702320625681,41.64251435962383],[-0.8985714463871408,41.64251305134],[-0.8985699934844978,41.64251225029684],[-0.898568779159912,41.64251355858065],[-0.8985671387859892,41.64251265417703],[-0.8985670000060308,41.64251280369516],[-0.8985560095019313,41.64250674419035],[-0.898602084415891,41.64245710416009],[-0.8986427656813304,41.642479533350496],[-0.8985980438855037,41.64252771559495]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.050"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f25","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.8985980438855037,41.64252771559495],[-0.8985976923766344,41.64252752179428],[-0.8985964780522985,41.64252883007834],[-0.8985948376775921,41.64252792567513],[-0.8985946988976645,41.642528075193304],[-0.8985717336566255,41.642515413545574],[-0.8985718724365792,41.64251526402741],[-0.8985702320625681,41.64251435962383],[-0.8985714463871408,41.64251305134],[-0.8985699934844978,41.64251225029684],[-0.898568779159912,41.64251355858065],[-0.8985671387859892,41.64251265417703],[-0.8985670000060308,41.64251280369516],[-0.8985560095019313,41.64250674419035],[-0.898602084415891,41.64245710416009],[-0.8986427656813304,41.642479533350496],[-0.8985980438855037,41.64252771559495]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.050"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f24","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.8986532776721355,41.6425581681301],[-0.8986530902005591,41.64255806476984],[-0.8986518758767209,41.642559373054524],[-0.8986502355004491,41.642558468652055],[-0.8986500967205776,41.642558618170305],[-0.8986271314576239,41.6425459565332],[-0.8986272702375199,41.642545807014976],[-0.8986256298619439,41.64254490261215],[-0.8986268441860182,41.64254359432775],[-0.8986253912819896,41.642542793285244],[-0.8986241769579014,41.642544101569655],[-0.8986225365824124,41.642543197166795],[-0.898622397802513,41.642543346684995],[-0.8985994325505162,41.642530685042594],[-0.8985995713304409,41.642530535524415],[-0.8985979309556482,41.6425296311212],[-0.8985991452799711,41.64252832283709],[-0.8985987937710957,41.64252812903642],[-0.898656595551549,41.642465854696255],[-0.8986569470602738,41.642466048496736],[-0.898658161382181,41.64246474021194],[-0.8986598017562437,41.642465644614276],[-0.8986599405358838,41.64246549509601],[-0.8986829057775955,41.64247815672618],[-0.8986827669979766,41.64247830624449],[-0.8986844073727343,41.6424792106465],[-0.8986831930510624,41.64248051893157],[-0.898684645954471,41.642481319973335],[-0.898685860276129,41.64248001168822],[-0.8986875006509742,41.64248091609018],[-0.8986876394305862,41.64248076657187],[-0.8987106046832553,41.64249342819676],[-0.8987104659036649,41.64249357771508],[-0.8987121062792053,41.642494482116675],[-0.898710891957783,41.64249579040206],[-0.8987110794292769,41.64249589376225],[-0.8986532776721355,41.6425581681301]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.060"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f23","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.8986532776721355,41.6425581681301],[-0.8986530902005591,41.64255806476984],[-0.8986518758767209,41.642559373054524],[-0.8986502355004491,41.642558468652055],[-0.8986500967205776,41.642558618170305],[-0.8986271314576239,41.6425459565332],[-0.8986272702375199,41.642545807014976],[-0.8986256298619439,41.64254490261215],[-0.8986268441860182,41.64254359432775],[-0.8986253912819896,41.642542793285244],[-0.8986241769579014,41.642544101569655],[-0.8986225365824124,41.642543197166795],[-0.898622397802513,41.642543346684995],[-0.8985994325505162,41.642530685042594],[-0.8985995713304409,41.642530535524415],[-0.8985979309556482,41.6425296311212],[-0.8985991452799711,41.64252832283709],[-0.8985987937710957,41.64252812903642],[-0.898656595551549,41.642465854696255],[-0.8986569470602738,41.642466048496736],[-0.898658161382181,41.64246474021194],[-0.8986598017562437,41.642465644614276],[-0.8986599405358838,41.64246549509601],[-0.8986829057775955,41.64247815672618],[-0.8986827669979766,41.64247830624449],[-0.8986844073727343,41.6424792106465],[-0.8986831930510624,41.64248051893157],[-0.898684645954471,41.642481319973335],[-0.898685860276129,41.64248001168822],[-0.8986875006509742,41.64248091609018],[-0.8986876394305862,41.64248076657187],[-0.8987106046832553,41.64249342819676],[-0.8987104659036649,41.64249357771508],[-0.8987121062792053,41.642494482116675],[-0.898710891957783,41.64249579040206],[-0.8987110794292769,41.64249589376225],[-0.8986532776721355,41.6425581681301]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.060"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f22","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.89871447952913,41.64249223056314],[-0.8987142920576404,41.64249212720295],[-0.8987130777363083,41.64249343548836],[-0.8987114373607795,41.64249253108676],[-0.8987112985811926,41.64249268060511],[-0.8986883333286434,41.642480018980386],[-0.8986884721082536,41.64247986946206],[-0.8986868317334197,41.64247896506015],[-0.8986880460549886,41.64247765677499],[-0.8986873196032987,41.642477256254146],[-0.8986865931516175,41.642476855733285],[-0.8986853788300357,41.6424781640184],[-0.8986837384552898,41.64247725961643],[-0.8986835996756753,41.64247740913472],[-0.8986606344340836,41.64246474750467],[-0.898660773213721,41.642464597986404],[-0.8986591328396714,41.64246369358409],[-0.8986603471614887,41.64246238529927],[-0.8986596207101452,41.64246198477824],[-0.8986588942588115,41.64246158425721],[-0.8986576799369788,41.64246289254203],[-0.8986560395630172,41.64246198813966],[-0.8986559007833738,41.642462137657944],[-0.8986329355527395,41.642449476022556],[-0.8986330743324055,41.64244932650435],[-0.8986314339591372,41.64244842210163],[-0.8986326482812049,41.6424471138171],[-0.8986311953792194,41.642446312774716],[-0.8986310565995564,41.64244646229293],[-0.8986234171477742,41.64244225036007],[-0.8986813576041981,41.642379826486035],[-0.8986904499540674,41.64238483945666],[-0.8986916642737169,41.642383531171426],[-0.8986933046462536,41.64238443557324],[-0.8986934434256381,41.64238428605493],[-0.8987164086459871,41.642396947678066],[-0.8987162698666264,41.6423970971964],[-0.8987179102398583,41.642398001597904],[-0.898716695920444,41.64239930988341],[-0.8987181488225003,41.642400110924704],[-0.8987193631419017,41.642398802639185],[-0.898721003515221,41.64239970704064],[-0.8987211422945762,41.64239955752228],[-0.8987441075258837,41.64241221914011],[-0.8987439687465526,41.64241236865849],[-0.8987456091205654,41.642413273059596],[-0.8987443948014008,41.6424145813454],[-0.8987451212527711,41.64241498186588],[-0.8987458477041504,41.64241538238639],[-0.8987470620233027,41.64241407410054],[-0.8987487023974043,41.642414978501634],[-0.8987488411767306,41.642414828983235],[-0.8987718064189959,41.642427490595736],[-0.8987716676396927,41.64242764011416],[-0.89877330801449,41.642428544514885],[-0.8987720936955726,41.64242985280099],[-0.8987722811669836,41.64242995616108],[-0.8987705117307616,41.64243186252081],[-0.898758888960798,41.64244438468687],[-0.8987575011670658,41.64244587987079],[-0.8987458783920023,41.6424584020354],[-0.898740882332068,41.64246378469681],[-0.8987292595504913,41.64247630685955],[-0.8987278717553716,41.64247780204309],[-0.8987162489686963,41.64249032420436],[-0.89871447952913,41.64249223056314]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.070"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f21","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.89871447952913,41.64249223056314],[-0.8987142920576404,41.64249212720295],[-0.8987130777363083,41.64249343548836],[-0.8987114373607795,41.64249253108676],[-0.8987112985811926,41.64249268060511],[-0.8986883333286434,41.642480018980386],[-0.8986884721082536,41.64247986946206],[-0.8986868317334197,41.64247896506015],[-0.8986880460549886,41.64247765677499],[-0.8986873196032987,41.642477256254146],[-0.8986865931516175,41.642476855733285],[-0.8986853788300357,41.6424781640184],[-0.8986837384552898,41.64247725961643],[-0.8986835996756753,41.64247740913472],[-0.8986606344340836,41.64246474750467],[-0.898660773213721,41.642464597986404],[-0.8986591328396714,41.64246369358409],[-0.8986603471614887,41.64246238529927],[-0.8986596207101452,41.64246198477824],[-0.8986588942588115,41.64246158425721],[-0.8986576799369788,41.64246289254203],[-0.8986560395630172,41.64246198813966],[-0.8986559007833738,41.642462137657944],[-0.8986329355527395,41.642449476022556],[-0.8986330743324055,41.64244932650435],[-0.8986314339591372,41.64244842210163],[-0.8986326482812049,41.6424471138171],[-0.8986311953792194,41.642446312774716],[-0.8986310565995564,41.64244646229293],[-0.8986234171477742,41.64244225036007],[-0.8986813576041981,41.642379826486035],[-0.8986904499540674,41.64238483945666],[-0.8986916642737169,41.642383531171426],[-0.8986933046462536,41.64238443557324],[-0.8986934434256381,41.64238428605493],[-0.8987164086459871,41.642396947678066],[-0.8987162698666264,41.6423970971964],[-0.8987179102398583,41.642398001597904],[-0.898716695920444,41.64239930988341],[-0.8987181488225003,41.642400110924704],[-0.8987193631419017,41.642398802639185],[-0.898721003515221,41.64239970704064],[-0.8987211422945762,41.64239955752228],[-0.8987441075258837,41.64241221914011],[-0.8987439687465526,41.64241236865849],[-0.8987456091205654,41.642413273059596],[-0.8987443948014008,41.6424145813454],[-0.8987451212527711,41.64241498186588],[-0.8987458477041504,41.64241538238639],[-0.8987470620233027,41.64241407410054],[-0.8987487023974043,41.642414978501634],[-0.8987488411767306,41.642414828983235],[-0.8987718064189959,41.642427490595736],[-0.8987716676396927,41.64242764011416],[-0.89877330801449,41.642428544514885],[-0.8987720936955726,41.64242985280099],[-0.8987722811669836,41.64242995616108],[-0.8987705117307616,41.64243186252081],[-0.898758888960798,41.64244438468687],[-0.8987575011670658,41.64244587987079],[-0.8987458783920023,41.6424584020354],[-0.898740882332068,41.64246378469681],[-0.8987292595504913,41.64247630685955],[-0.8987278717553716,41.64247780204309],[-0.8987162489686963,41.64249032420436],[-0.89871447952913,41.64249223056314]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.070"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f20","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.898775681259819,41.64242629295995],[-0.8987754937884135,41.64242618959987],[-0.8987742794695869,41.64242749788599],[-0.8987726390948018,41.642426593485276],[-0.898772500315503,41.64242674300369],[-0.8987495350733562,41.64241408139133],[-0.8987496738526785,41.64241393187293],[-0.8987480334785883,41.6424130274719],[-0.8987492477976508,41.642411719186036],[-0.8987485213462902,41.642411318665566],[-0.898747794894938,41.64241091814512],[-0.8987465805758622,41.642412226430956],[-0.8987449402018594,41.64241132202985],[-0.8987448014225329,41.642411471548236],[-0.8987218361913419,41.64239880993053],[-0.8987219749706947,41.64239866041221],[-0.898720334597387,41.642397756010766],[-0.8987215489166984,41.64239644772522],[-0.8987200960146785,41.64239564668394],[-0.8987188816953542,41.642396954969485],[-0.8987172413221345,41.642396050568],[-0.898717102542779,41.64239620008635],[-0.8986941373225461,41.642383538463356],[-0.8986942761019264,41.642383388945035],[-0.8986926357294022,41.64238248454323],[-0.8986938500489629,41.64238117625797],[-0.8986847576993215,41.64237616328761],[-0.8987425592567846,41.6423138888976],[-0.8987501987018316,41.64231810082245],[-0.8987516516025364,41.64231890186331],[-0.898752865919681,41.64231759357736],[-0.8987545062914738,41.6423184979783],[-0.8987546450705708,41.64231834845991],[-0.8987776102805162,41.642331010070684],[-0.8987774715014434,41.64233115958909],[-0.8987791118739323,41.64233206398971],[-0.8987778975570244,41.64233337227593],[-0.898778624007719,41.642333772796206],[-0.8987793504584222,41.64233417331646],[-0.8987805647753172,41.64233286503023],[-0.8987822051478933,41.642333769430785],[-0.8987823439269612,41.64233361991238],[-0.8988053091478672,41.64234628151781],[-0.8988051703688203,41.64234643103628],[-0.8988068107420919,41.642347335436504],[-0.8988055964254332,41.64234864372301],[-0.8988063228764743,41.64234904424311],[-0.8988070493275241,41.64234944476321],[-0.8988082636441703,41.64234813647668],[-0.8988099040175294,41.64234904087686],[-0.8988100427965685,41.642348891358395],[-0.8988330080284312,41.64236155295855],[-0.8988328692494143,41.642361702477025],[-0.8988345096234673,41.64236260687687],[-0.898833295307058,41.6423639151637],[-0.8988334827783837,41.64236401852367],[-0.8988317133458122,41.642365924884444],[-0.898820090599835,41.64237844705741],[-0.8988187028089669,41.64237994224213],[-0.8988070800578899,41.64239246441364],[-0.8988020840082662,41.64239784707801],[-0.898790461250676,41.642410369247614],[-0.8987890734584215,41.64241186443197],[-0.8987774506957324,41.64242438660013],[-0.898775681259819,41.64242629295995]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.080"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f1f","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.898775681259819,41.64242629295995],[-0.8987754937884135,41.64242618959987],[-0.8987742794695869,41.64242749788599],[-0.8987726390948018,41.642426593485276],[-0.898772500315503,41.64242674300369],[-0.8987495350733562,41.64241408139133],[-0.8987496738526785,41.64241393187293],[-0.8987480334785883,41.6424130274719],[-0.8987492477976508,41.642411719186036],[-0.8987485213462902,41.642411318665566],[-0.898747794894938,41.64241091814512],[-0.8987465805758622,41.642412226430956],[-0.8987449402018594,41.64241132202985],[-0.8987448014225329,41.642411471548236],[-0.8987218361913419,41.64239880993053],[-0.8987219749706947,41.64239866041221],[-0.898720334597387,41.642397756010766],[-0.8987215489166984,41.64239644772522],[-0.8987200960146785,41.64239564668394],[-0.8987188816953542,41.642396954969485],[-0.8987172413221345,41.642396050568],[-0.898717102542779,41.64239620008635],[-0.8986941373225461,41.642383538463356],[-0.8986942761019264,41.642383388945035],[-0.8986926357294022,41.64238248454323],[-0.8986938500489629,41.64238117625797],[-0.8986847576993215,41.64237616328761],[-0.8987425592567846,41.6423138888976],[-0.8987501987018316,41.64231810082245],[-0.8987516516025364,41.64231890186331],[-0.898752865919681,41.64231759357736],[-0.8987545062914738,41.6423184979783],[-0.8987546450705708,41.64231834845991],[-0.8987776102805162,41.642331010070684],[-0.8987774715014434,41.64233115958909],[-0.8987791118739323,41.64233206398971],[-0.8987778975570244,41.64233337227593],[-0.898778624007719,41.642333772796206],[-0.8987793504584222,41.64233417331646],[-0.8987805647753172,41.64233286503023],[-0.8987822051478933,41.642333769430785],[-0.8987823439269612,41.64233361991238],[-0.8988053091478672,41.64234628151781],[-0.8988051703688203,41.64234643103628],[-0.8988068107420919,41.642347335436504],[-0.8988055964254332,41.64234864372301],[-0.8988063228764743,41.64234904424311],[-0.8988070493275241,41.64234944476321],[-0.8988082636441703,41.64234813647668],[-0.8988099040175294,41.64234904087686],[-0.8988100427965685,41.642348891358395],[-0.8988330080284312,41.64236155295855],[-0.8988328692494143,41.642361702477025],[-0.8988345096234673,41.64236260687687],[-0.898833295307058,41.6423639151637],[-0.8988334827783837,41.64236401852367],[-0.8988317133458122,41.642365924884444],[-0.898820090599835,41.64237844705741],[-0.8988187028089669,41.64237994224213],[-0.8988070800578899,41.64239246441364],[-0.8988020840082662,41.64239784707801],[-0.898790461250676,41.642410369247614],[-0.8987890734584215,41.64241186443197],[-0.8987774506957324,41.64242438660013],[-0.898775681259819,41.64242629295995]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.080"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f1e","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.898836882864201,41.64236035532054],[-0.8988366953928818,41.642360251960554],[-0.8988354810765606,41.64236156024741],[-0.8988338407025186,41.64236065584757],[-0.898833701923505,41.64236080536608],[-0.8988107366917614,41.64234814376604],[-0.898810875470799,41.64234799424761],[-0.8988092350974523,41.64234708984743],[-0.8988104494140086,41.64234578156087],[-0.8988097229629762,41.642345381040805],[-0.8988089965119538,41.64234498052071],[-0.8988077821953843,41.64234628880727],[-0.8988061418221245,41.64234538440706],[-0.8988060030430828,41.642345533925536],[-0.8987830378222973,41.64233287232019],[-0.8987831766013616,41.64233272280177],[-0.898781536228798,41.64233181840122],[-0.8987827505456042,41.642330510114945],[-0.8987820240949185,41.64233010959471],[-0.8987812976442421,41.64232970907447],[-0.898780083327422,41.64233101736071],[-0.8987784429549464,41.64233011296013],[-0.8987783041758761,41.64233026247856],[-0.898755338966048,41.64231760086791],[-0.8987554777451402,41.6423174513495],[-0.8987538373733611,41.64231654694859],[-0.8987550516904154,41.64231523866261],[-0.8987547939177118,41.64231509654248],[-0.8987538565624422,41.642314579741964],[-0.8987535987897458,41.6423144376218],[-0.8987523844726776,41.64231574590776],[-0.8987507441009845,41.642314841506796],[-0.8987506053218863,41.64231499102518],[-0.8987276401230156,41.642302329409226],[-0.8987277789021362,41.64230217989087],[-0.8987261385311377,41.64230127548955],[-0.898737761280433,41.642288753326056],[-0.8988472912877544,41.642349141432675],[-0.8988386522964633,41.642358448959655],[-0.898836882864201,41.64236035532054]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.090"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f1d","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.898836882864201,41.64236035532054],[-0.8988366953928818,41.642360251960554],[-0.8988354810765606,41.64236156024741],[-0.8988338407025186,41.64236065584757],[-0.898833701923505,41.64236080536608],[-0.8988107366917614,41.64234814376604],[-0.898810875470799,41.64234799424761],[-0.8988092350974523,41.64234708984743],[-0.8988104494140086,41.64234578156087],[-0.8988097229629762,41.642345381040805],[-0.8988089965119538,41.64234498052071],[-0.8988077821953843,41.64234628880727],[-0.8988061418221245,41.64234538440706],[-0.8988060030430828,41.642345533925536],[-0.8987830378222973,41.64233287232019],[-0.8987831766013616,41.64233272280177],[-0.898781536228798,41.64233181840122],[-0.8987827505456042,41.642330510114945],[-0.8987820240949185,41.64233010959471],[-0.8987812976442421,41.64232970907447],[-0.898780083327422,41.64233101736071],[-0.8987784429549464,41.64233011296013],[-0.8987783041758761,41.64233026247856],[-0.898755338966048,41.64231760086791],[-0.8987554777451402,41.6423174513495],[-0.8987538373733611,41.64231654694859],[-0.8987550516904154,41.64231523866261],[-0.8987547939177118,41.64231509654248],[-0.8987538565624422,41.642314579741964],[-0.8987535987897458,41.6423144376218],[-0.8987523844726776,41.64231574590776],[-0.8987507441009845,41.642314841506796],[-0.8987506053218863,41.64231499102518],[-0.8987276401230156,41.642302329409226],[-0.8987277789021362,41.64230217989087],[-0.8987261385311377,41.64230127548955],[-0.898737761280433,41.642288753326056],[-0.8988472912877544,41.642349141432675],[-0.8988386522964633,41.642358448959655],[-0.898836882864201,41.64236035532054]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.090"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f1c","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.8987260171178183,41.6422992307628],[-0.8987258999484653,41.642299166162715],[-0.8987246856311497,41.64230047444838],[-0.8987230452602383,41.64229957004703],[-0.8987229064811121,41.64229971956539],[-0.8986999412931993,41.64228705794413],[-0.8987000800723487,41.64228690842579],[-0.8986984397021327,41.6422860040241],[-0.8986996540196852,41.64228469573872],[-0.8986994665488086,41.642284592378545],[-0.8987098749829486,41.642273378503255],[-0.8987364255499121,41.64228801688511],[-0.8987260171178183,41.6422992307628]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.100"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f1b","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.8987260171178183,41.6422992307628],[-0.8987258999484653,41.642299166162715],[-0.8987246856311497,41.64230047444838],[-0.8987230452602383,41.64229957004703],[-0.8987229064811121,41.64229971956539],[-0.8986999412931993,41.64228705794413],[-0.8987000800723487,41.64228690842579],[-0.8986984397021327,41.6422860040241],[-0.8986996540196852,41.64228469573872],[-0.8986994665488086,41.642284592378545],[-0.8987098749829486,41.642273378503255],[-0.8987364255499121,41.64228801688511],[-0.8987260171178183,41.6422992307628]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.100"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f1a","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.8987692914191054,41.64230466791389],[-0.8987107770470679,41.642272406634014],[-0.8987572680068739,41.64222231797794],[-0.8987574554776713,41.64222242133803],[-0.8987586697928072,41.64222111305197],[-0.8987603101622923,41.64222201745277],[-0.8987604489411596,41.64222186793437],[-0.8987637062464138,41.642223663815905],[-0.8987715800210181,41.642228004939305],[-0.8987729860523106,41.64222878013986],[-0.8987808598281736,41.64223312126262],[-0.8987834141187884,41.64223452954342],[-0.8987832753399433,41.64223467906185],[-0.8987849157101236,41.64223558346232],[-0.8987837013952236,41.64223689174868],[-0.8987844278448959,41.6422372922689],[-0.8987851542945777,41.6422376927891],[-0.8987863686094643,41.64223638450274],[-0.8987880089797322,41.64223728890317],[-0.8987881477585716,41.64223713938473],[-0.8987911707267537,41.64223880606548],[-0.8987990445050835,41.642243147187045],[-0.8988004505370416,41.64224392238728],[-0.8988083243166299,41.64224826350824],[-0.898811112947157,41.642249800988466],[-0.8988109741683402,41.64224995050693],[-0.8988126145393035,41.64225085490702],[-0.8988114002246523,41.642252163193675],[-0.8988116579972392,41.642252305313704],[-0.8988125953521086,41.64225282211376],[-0.8988128531246992,41.64225296423376],[-0.8988140674393372,41.6422516559471],[-0.8988157078103878,41.64225256034716],[-0.898815846589199,41.64225241082868],[-0.898818635220088,41.64225394830872],[-0.8988265090021422,41.642258289428504],[-0.8988266027376494,41.64225834110847],[-0.8987787587079095,41.64230988759767],[-0.8987692914191054,41.64230466791389]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.110"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f19","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.8987692914191054,41.64230466791389],[-0.8987107770470679,41.642272406634014],[-0.8987572680068739,41.64222231797794],[-0.8987574554776713,41.64222242133803],[-0.8987586697928072,41.64222111305197],[-0.8987603101622923,41.64222201745277],[-0.8987604489411596,41.64222186793437],[-0.8987637062464138,41.642223663815905],[-0.8987715800210181,41.642228004939305],[-0.8987729860523106,41.64222878013986],[-0.8987808598281736,41.64223312126262],[-0.8987834141187884,41.64223452954342],[-0.8987832753399433,41.64223467906185],[-0.8987849157101236,41.64223558346232],[-0.8987837013952236,41.64223689174868],[-0.8987844278448959,41.6422372922689],[-0.8987851542945777,41.6422376927891],[-0.8987863686094643,41.64223638450274],[-0.8987880089797322,41.64223728890317],[-0.8987881477585716,41.64223713938473],[-0.8987911707267537,41.64223880606548],[-0.8987990445050835,41.642243147187045],[-0.8988004505370416,41.64224392238728],[-0.8988083243166299,41.64224826350824],[-0.898811112947157,41.642249800988466],[-0.8988109741683402,41.64224995050693],[-0.8988126145393035,41.64225085490702],[-0.8988114002246523,41.642252163193675],[-0.8988116579972392,41.642252305313704],[-0.8988125953521086,41.64225282211376],[-0.8988128531246992,41.64225296423376],[-0.8988140674393372,41.6422516559471],[-0.8988157078103878,41.64225256034716],[-0.898815846589199,41.64225241082868],[-0.898818635220088,41.64225394830872],[-0.8988265090021422,41.642258289428504],[-0.8988266027376494,41.64225834110847],[-0.8987787587079095,41.64230988759767],[-0.8987692914191054,41.64230466791389]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.110"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f18","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.898887954093663,41.64230685855055],[-0.8988870167374009,41.642306341751066],[-0.898886669790473,41.64230671554748],[-0.898881292112568,41.64231250939171],[-0.8988799043245632,41.64231400457727],[-0.8988682815974736,41.64232652675565],[-0.8988632855581608,41.642331909422964],[-0.8988516628245568,41.64234443159947],[-0.8988502750351659,41.64234592678463],[-0.8988481933509574,41.64234816956233],[-0.8987894445604945,41.642315779121],[-0.8987799772699469,41.64231055943807],[-0.8988278212992551,41.64225901294841],[-0.8988357888180781,41.64226340574753],[-0.8988388117887418,41.64226507242709],[-0.898838673009955,41.642265221945586],[-0.8988403133816999,41.64226612634531],[-0.8988390990672972,41.64226743463226],[-0.8988393568400068,41.642267576752225],[-0.8988402941953232,41.64226809355206],[-0.8988405519680372,41.64226823567202],[-0.8988417662824274,41.642266927385045],[-0.8988434066542599,41.642267831784736],[-0.898843545433043,41.6422676822662],[-0.8988460997264136,41.64226909054567],[-0.8988539735121952,41.642273431663625],[-0.8988553795454813,41.64227420686322],[-0.898863253332521,41.64227854798056],[-0.8988665106435425,41.64228034385931],[-0.8988663718647842,41.64228049337785],[-0.8988680122373117,41.6422813977772],[-0.8988667979231585,41.64228270606444],[-0.8988675243738705,41.64228310658414],[-0.8988682508245933,41.64228350710384],[-0.8988694651387332,41.64228219881659],[-0.8988711055113474,41.64228310321588],[-0.8988712442901021,41.64228295369733],[-0.8988735642457345,41.642284232776284],[-0.8988814380352413,41.64228857389244],[-0.8988828440691929,41.64228934909171],[-0.8988907178599579,41.64229369020724],[-0.8988942095115602,41.6422956152851],[-0.8988940707328303,41.64229576480369],[-0.8988957111061414,41.64229666920265],[-0.8988944967922357,41.64229797749019],[-0.8988946842634761,41.642298080850075],[-0.8988929148345577,41.64229998721189],[-0.8988925678876984,41.642300361008324],[-0.8988935052439244,41.64230087780775],[-0.898887954093663,41.64230685855055]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.120"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f17","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.898887954093663,41.64230685855055],[-0.8988870167374009,41.642306341751066],[-0.898886669790473,41.64230671554748],[-0.898881292112568,41.64231250939171],[-0.8988799043245632,41.64231400457727],[-0.8988682815974736,41.64232652675565],[-0.8988632855581608,41.642331909422964],[-0.8988516628245568,41.64234443159947],[-0.8988502750351659,41.64234592678463],[-0.8988481933509574,41.64234816956233],[-0.8987894445604945,41.642315779121],[-0.8987799772699469,41.64231055943807],[-0.8988278212992551,41.64225901294841],[-0.8988357888180781,41.64226340574753],[-0.8988388117887418,41.64226507242709],[-0.898838673009955,41.642265221945586],[-0.8988403133816999,41.64226612634531],[-0.8988390990672972,41.64226743463226],[-0.8988393568400068,41.642267576752225],[-0.8988402941953232,41.64226809355206],[-0.8988405519680372,41.64226823567202],[-0.8988417662824274,41.642266927385045],[-0.8988434066542599,41.642267831784736],[-0.898843545433043,41.6422676822662],[-0.8988460997264136,41.64226909054567],[-0.8988539735121952,41.642273431663625],[-0.8988553795454813,41.64227420686322],[-0.898863253332521,41.64227854798056],[-0.8988665106435425,41.64228034385931],[-0.8988663718647842,41.64228049337785],[-0.8988680122373117,41.6422813977772],[-0.8988667979231585,41.64228270606444],[-0.8988675243738705,41.64228310658414],[-0.8988682508245933,41.64228350710384],[-0.8988694651387332,41.64228219881659],[-0.8988711055113474,41.64228310321588],[-0.8988712442901021,41.64228295369733],[-0.8988735642457345,41.642284232776284],[-0.8988814380352413,41.64228857389244],[-0.8988828440691929,41.64228934909171],[-0.8988907178599579,41.64229369020724],[-0.8988942095115602,41.6422956152851],[-0.8988940707328303,41.64229576480369],[-0.8988957111061414,41.64229666920265],[-0.8988944967922357,41.64229797749019],[-0.8988946842634761,41.642298080850075],[-0.8988929148345577,41.64229998721189],[-0.8988925678876984,41.642300361008324],[-0.8988935052439244,41.64230087780775],[-0.898887954093663,41.64230685855055]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.120"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f16","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.8987227576323884,41.642302971482515],[-0.8987224998598087,41.64230282936229],[-0.8987237141772149,41.642301521076654],[-0.898721819442289,41.64230047643434],[-0.8987222125854218,41.642300467156936],[-0.8986992473973907,41.64228780553554],[-0.8986991086182372,41.64228795505386],[-0.8986974682480094,41.64228705065213],[-0.8986962539303671,41.64228835893752],[-0.8986960664594846,41.64228825557733],[-0.898673133887973,41.64231296273046],[-0.8986865966445052,41.64232038528663],[-0.8986865966445052,41.64232038528663],[-0.8986998250654075,41.64232767864104],[-0.8987227576323884,41.642302971482515],[-0.8987227576323884,41.642302971482515]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.130"}},{"type":"Feature","id":"csf_1097_00.fid--32b65a4c_157e0d33941_-7f15","geometry":{"type":"MultiPolygon","coordinates":[[[[-0.8987227576323884,41.642302971482515],[-0.8987224998598087,41.64230282936229],[-0.8987237141772149,41.642301521076654],[-0.898721819442289,41.64230047643434],[-0.8987222125854218,41.642300467156936],[-0.8986992473973907,41.64228780553554],[-0.8986991086182372,41.64228795505386],[-0.8986974682480094,41.64228705065213],[-0.8986962539303671,41.64228835893752],[-0.8986960664594846,41.64228825557733],[-0.898673133887973,41.64231296273046],[-0.8986865966445052,41.64232038528663],[-0.8986865966445052,41.64232038528663],[-0.8986998250654075,41.64232767864104],[-0.8987227576323884,41.642302971482515],[-0.8987227576323884,41.642302971482515]]]]},"geometry_name":"the_geom","properties":{"id":0,"et_id":"CSF.1097.00.130"}}],"crs":{"type":"name","properties":{"name":"urn:ogc:def:crs:EPSG::4326"}}};
        handleJson(data, planta_id, sharedProperties, poisService, createModal, function(plano, addLegendToPlan){
                    if (addLegendToPlan) {
                        addLegend(plano, function(){
                            // Define legend behaviour
                            $('.legend').hide();
                            $('.legend-button').click(function(){
                                if ($('.legend').is(":visible")) $('.legend').hide(500);
                                else $('.legend').show(500);
                            });
                            sharedProperties.setPlano(plano);
                        });
                    } else {
                        sharedProperties.setPlano(plano);
                    }
                });

        function handleJson(data, planta_id, sharedProperties, poisService, createModal, callback) {
            console.log("handleJson", data, planta_id);
            var plano = sharedProperties.getPlano(),
                coordinates = data.features[0].geometry.coordinates[0][0][0],
                floorCoordinates = new L.latLng(coordinates[1], coordinates[0]);
                addLegendToPlan = true;

            //Remove previous plan layers
            if(!(typeof plano == 'undefined')) {
                plano.remove();
                plano.invalidateSize();
                addLegendToPlan = false;
            }

            var imageLayer = new L.tileLayer.wms(APP_CONSTANTS.URI_Geoserver_2 + "sigeuz/wms", 
            {
                layers: 'sigeuz:vista_plantas',
                maxZoom: 25,
                zIndex: 5,
                viewparams : 'PLANTA:'+planta_id,
                format: 'image/png', transparent: true, attribution: planta_id
            });

            var mapProperties = 
            {
                crs: L.CRS.EPSG3857,
                layers: [imageLayer]
            };

            plano = new L.map('plan', mapProperties).setView(floorCoordinates, 20);
            plano.setMaxBounds(L.geoJson(data).getBounds());

            $('.leaflet-container').css('cursor','pointer');

            //On 'click' event --> Show room information if room has been clicked
            plano.on('click', function(point){
                var srcRoom = new Proj4js.Proj('EPSG:4326');
                var dstRoom = new Proj4js.Proj('EPSG:25830');
                var pRoom = new Proj4js.Point(point.latlng.lng,point.latlng.lat);
                Proj4js.transform(srcRoom, dstRoom, pRoom);

                var defaultParameters = {
                    service : 'WFS',
                    version : '1.1.1',
                    request : 'GetFeature',
                    typeName : "sigeuz:vista_plantas",
                    maxFeatures : 500,
                    outputFormat : 'text/javascript',
                    format_options : 'callback:getJson',
                    SrsName : 'EPSG:4326'
                };
                
                var customParams = {
                    cql_filter:'DWithin(geom, POINT(' + pRoom.x + ' ' + pRoom.y + '), 0.1, meters)',
                    viewparams:'PLANTA:'+planta_id
                };

                var parameters = L.Util.extend(defaultParameters, customParams);

                var owsrootUrl = APP_CONSTANTS.URI_Geoserver_2 + 'ows';

                $.ajax({
                    url : owsrootUrl + L.Util.getParamString(parameters),
                    dataType : 'jsonp',
                    jsonpCallback : 'getJson',
                    success : handleJsonClick
                });
            });

            //On 'contextmenu' event --> Show 'Create POI modal' if room has been clicked
            plano.on('contextmenu', function(e){
                localStorage.contextMenuClickedPoint = JSON.stringify(e.latlng);
                var srcRoom = new Proj4js.Proj('EPSG:4326');
                var dstRoom = new Proj4js.Proj('EPSG:25830');
                var pRoom = new Proj4js.Point(e.latlng.lng,e.latlng.lat);
                Proj4js.transform(srcRoom, dstRoom, pRoom);

                var defaultParameters = {
                    service : 'WFS',
                    version : '1.1.1',
                    request : 'GetFeature',
                    typeName : "sigeuz:vista_plantas",
                    maxFeatures : 500,
                    outputFormat : 'text/javascript',
                    format_options : 'callback:getJson',
                    SrsName : 'EPSG:4326'
                };
                
                var customParams = {
                    cql_filter:'DWithin(geom, POINT(' + pRoom.x + ' ' + pRoom.y + '), 0.1, meters)',
                    viewparams:'PLANTA:'+planta_id
                };

                var parameters = L.Util.extend(defaultParameters, customParams);

                var owsrootUrl = APP_CONSTANTS.URI_Geoserver_2 + 'ows';

                $.ajax({
                    url : owsrootUrl + L.Util.getParamString(parameters),
                    dataType : 'jsonp',
                    jsonpCallback : 'getJson',
                    success : handleJsonContextMenu
                });
            });

            console.log("Last search", localStorage.lastSearch);
                    
            updatePOIs(plano, sharedProperties);

            callback(plano, addLegendToPlan);
        }

        function handleJsonContextMenu(data) {
            if (data.features.length) {
                console.log("handleJsonContextMenu",data);
                var selectedRoom = null;
                var selectedFeature = L.geoJson(data, {
                    onEachFeature: function (feature, layer) {
                        selectedRoom = layer;
                        layer.on({
                            contextmenu: function(e){
                                var pointClicked = JSON.parse(localStorage.contextMenuClickedPoint),
                                    roomId = data.features[0].properties.id_unico
                                createModal(pointClicked, roomId);
                            }
                        });
                    }
                });
                var currentPlano = sharedProperties.getPlano();
                var currentLayers = [];
                currentPlano.eachLayer(function(layer){
                    currentLayers.push(layer);
                });
                currentLayers.forEach(function(layer,i){
                    if (i !== 0) currentPlano.removeLayer(layer);
                });
                selectedFeature.addTo(currentPlano);
                selectedRoom.fireEvent('contextmenu');
                sharedProperties.setPlano(currentPlano);
                updatePOIs(currentPlano, sharedProperties);
            }
        }

        function handleJsonClick(data) {
            if (data.features.length) {
                console.log("handleJsonClick",data);
                var selectedRoom = null;
                var selectedFeature = L.geoJson(data, {
                    onEachFeature: function (feature, layer) {
                        selectedRoom = layer;
                        layer.on({
                            click: whenClicked
                        });
                    }
                });
                var currentPlano = sharedProperties.getPlano();
                var currentLayers = [];
                currentPlano.eachLayer(function(layer){
                    currentLayers.push(layer);
                });
                currentLayers.forEach(function(layer,i){
                    if (i !== 0) currentPlano.removeLayer(layer);
                });
                selectedFeature.addTo(currentPlano);
                selectedRoom.fireEvent('click');
                sharedProperties.setPlano(currentPlano);
                updatePOIs(currentPlano, sharedProperties);
            }
        }

        //Show info about room clicked on map
        function whenClicked(e) {
            console.log("Room clicked", e);
            var id = e.target.feature.properties.id_unico;
            var roomCoordinates = e.target.feature.geometry.coordinates[0][0][0];
            var roomLatLng = new L.LatLng(roomCoordinates[1],roomCoordinates[0]);

            infoService.getInfoEstancia(id).then(
                function (data) {
                    if (data == null) {
                        console.log("There's no info on room ", id);
                        var errorMsg = '<div class="text-center">No se dispone de información<br>';
                        errorMsg += 'sobre la estancia seleccionada</div>';
                        showInfoPopup('¡Aviso!', errorMsg);
                    } else {
                        $scope.infoEstancia = data;
                        console.log("infoEstancia",data);

                        var html_list = '<div><ul class="list-group">';
                        var html_list_items = '<li class="list-group-item">'+data.ID_espacio+'</li>';
                        html_list_items += '<li class="list-group-item">'+data.ID_centro+'</li>';
                        html_list = html_list + html_list_items + '</ul></div>';
                        var html_button = '<div class="info-btn-div"><button value="'+data.ID_espacio+'" class="button button-small button-positive" onclick="informacionEstancia(this)">'+$scope.translation.MASINFO+' </button></div>';
                        var html =  html_list + html_button;

                        var currentPlano = sharedProperties.getPlano();
                        L.popup().setLatLng(roomLatLng).setContent(html).openOn(currentPlano);
                    }
                },
                function(err){
                    console.log("Error on getInfoEstancia", err);
                    var errorMsg = '<div class="text-center">Ha ocurrido un error recuperando<br>';
                    errorMsg += 'la información del espacio</div>';
                    showInfoPopup('¡Error!', errorMsg);
                }
            );
        }

        //Add legend to map
        function addLegend(plano, callback) {
            var legend = L.control({position: 'topright'});
            legend.onAdd = function (map) {
                var div = L.DomUtil.create('div', '');
                var button = '<button class="button button-positive button-small legend-button">';
                button += '<i class="icon ion-ios-help-outline"></i>';
                button += '</button>';
                var legend = '<div class="legend">';
                APP_CONSTANTS.pois.forEach(function(poi){
                   legend += '<i class="'+poi.class+'">'+poi.label+'</i></br>';
                });
                legend += '</div>';
                div.innerHTML = button + '<br>' + legend;
                 L.DomEvent.disableClickPropagation(div);
                return div;
            };
            legend.addTo(plano);
            callback();
        }
    }

    //Add markers for every POI
    function updatePOIs(plano, sharedProperties) {
        var building = localStorage.building.indexOf('building') == -1 ? localStorage.building : JSON.parse(localStorage.building).building,
            floor = localStorage.planta,
            markers = [];

        poisService.getRoomPOIs(building, floor).then(
            function(pois) {
                console.log("Get room POIs success",pois);
                pois.forEach(function(poi){
                    var iconClass = $.grep(APP_CONSTANTS.pois, function(e) { return e.value == poi.category })[0].class;
                    var poiLabel = $.grep(APP_CONSTANTS.pois, function(e) { return e.value == poi.category })[0].label;
                    var icon = L.divIcon({className: iconClass});

                    var html = '<div class="text-center">';
                    html += '<b>Categoría:</b> '+poiLabel+'</br>';
                    html += '<b>Comentarios:</b> '+poi.comments+'</div>';
                    html += '<div class="edit-btn-div">';
                    html += '<button class="button button-small button-positive button-edit-poi" onclick="editPOI()" data-id="'+poi.id+'">Editar</button></div>';
                    var marker = new L.marker([poi.latitude, poi.longitude], {icon: icon})
                    markers.push(marker);
                    marker.addTo(plano)
                    marker.bindPopup(html);
                });

                sharedProperties.getLastMarkers().forEach(function(marker){
                    plano.removeLayer(marker);
                });

                sharedProperties.setLastMarkers(markers);
            },
            function(err){
                console.log("Error on getRoomPOIs", err);
                $ionicPopup.alert({
                    title: '¡Error!',
                    template: '<div class="text-center">Ha ocurrido un error recuperando<br>los puntos de interés</div>'
                });
            }
        );
    }

    function showInfoPopup(title, msg){
        if ($('.ionic-alert-popup').is(":visible") == false) {
            $ionicPopup.alert({
                cssClass: 'ionic-alert-popup',
                title: title,
                template: msg
            });
        }
    }
});
